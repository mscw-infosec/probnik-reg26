# Неэтичное общение

## Информация

Долорес Амбридж постановила всем магам переходить на новый магический мессенджер.
Вам уже так полюбившаяся по остальынм таскам троица, конечно, заподозрила неладное –
не собирается ли так скверная розовая помощница Министра следить за невинными друзьями?
Конечно, вопрос о том, как вблизи сил магии можно пользоваться каким-то мессенджером,
ребят уже не интересовал – мессенджер-то магический, он и в Хогвартсе ловит поди.

Впрочем, сама Амбридж заявляет, что все сообщения и кнаты магов и прочих существ
в надёжных руках – а ведь никто не должен врать. Все мы знаем, что именно о твоих
познаниях в кибербезопасности наслышана половина английской магической элиты тех
и настоящих времен – коллеги видели твой постер и так круто они бы не смогли.

И как один они все твердят, что тут и реверс-инжиниринга никакого
не надо, чтобы убедить семью, коллег, друзей и прочих знакомых общаться по-старинке,
совами и посыльными (aka великаном на мотоцикле).

Придется вам выдержать планку и показать Министерству магии кузькину мать. И да,
местами понадобится отлаживать пятисотки за разаработчиков.

## Решение

Что ж, не зря в санитизации (`models.js:sanitize`) разрешили svg, так еще и с атрибутом onload. Велик соблазн начать эксплуатировать XSS, но нужно доизучить всё.

Действительно, вместо Амбридж личку читает бот (bot.js), а логин в админа как раз позволяет стащить флаг.

Создаем пост

```html
<svg onload="fetch('/api/admin/promote/harry', {method: 'PUT', headers: {'Authorization': 'Bearer ' + localStorage.getItem('token')}})"></svg>
```

Просим Амбридж прочитать его, она переходит и делает Гарри админом. Что произошло: при загрузке этого svg произошел запрос на API повышения Гарри.

В админке Долорес есть сломанная шпионилка за сообщениями, из кода ясно, что сообщения живут в
mongoDB. Вместо получения сообщения с ровно таким текстом мы пытаемся получить сообщение с нужным
префиксом (по формату флага). Авторское решение использует тут слепую NoSQL Injection: [hacktricks-ссылка](https://hacktricks.infosec.moscow/pentesting-web/nosql-injection.html#blind-nosql-script).

Можно делать через операторы $regex (сравнения запроса с регулярным выражением – см страницу выше) или через $gt (>), зная формат флага vsosh{} и отправителя искомого сообщения.

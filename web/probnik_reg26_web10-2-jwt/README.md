# Восточный шпионаж

## Информация

А вот и суббота!

На парах по защите от темных искусств свежевербованный преподаватель начал пояснять,
кому можно секретные заклинания и прочую силушку нечис... магию тайную показывать,
а кому (ну то есть маглам) не очень.

Кто ж его знает, зачем тот же препод начал им рассказывать про JWT, небось и поможет это найти смысл в
Турнире трёх волшебников, захватить мир и наконец купить квартиру в центре ~~Москвы~~ Хогсмида,
но больно хорошо Чжоу Чанг усвоила всю секретность тех самых строчек на `eyJhb`. Уже желая узнать все
тайны мальчика с молнией посередине лба, наверстала она ему декодер их, родимых.

Гарри наш тоже был не палочкой деланный, и на правах очень внимательного слушателя и отличника по зельеварению
раскрыл план когтевранки. Чего только не придумают шестнадцатилетние чародеи, чтобы повеселиться над шпионами –
например, Гарри, прочитав вашу пояснительную записку, придумал обратиться к Вам, как к опытному специалисту в кибербезопасности.

## Решение

В таске два флага.

Сначала надо наPPCшить пин-код от админки (быки и коровы). За это дают легкий флаг. Что такое быки и коровы – понятно из кода, а в жизни это известная модель попыток угадывания числа, где угадывающему говорят в ответ на очередную попытку количество угаданных цифр, поставленных в попытке на свои места, и количество угаданных цифр не на своих местах.

Как делать PPC: в запросах можно использовать одинаковые цифры, поэтому можно сделать 10 запросов вида `111111`,
чтобы узнать, сколько раз встречается каждая цифра, потом с какой-нибудь неиспользуемой цифрой (пусть 6) делать
запросы вида `166666`, `616666` и так далее. Так мы сможем узнать, на каких позициях единичка. В сто запросов точно уложиться можно.

Можно еще меньше думать и выбирать случайное число, которое подходит под уже сделанные запросы (потенциальный ответ на вопрос, про который мы пока не знаем, что это не пароль). Эксперименты показали, что 10 попыток достаточно.

Как мы видим из исходников, в админке реализован поиск по alg в jwt body. C SQL-инъекцией. Но возвращается только количество... по крайней мере, COUNT() от ответа.

Можно использовать либо слепую SQL-инъекцию с бинарным поиском, выполняя запросы вида `s < 'vsosh{knownX}'` – но это ~400 запросов, так как флаг довольно длинный. Хитрее использовать [(hacktricks link)](https://hacktricks.infosec.moscow/pentesting-web/sql-injection/index.html?highlight=blind%20sql#union-select) UNION-based. Видим пример запроса `UNION`, подставляем вместо `SELECT null` нужный нам `SELECT`:  `' UNION SELECT jwt FROM tokens; -- `. Ура, мы сдампили все JWT, благо их можно раздекодировать этим же сервисом.
